# NOTE: This file is kept for reference only.
# The actual deployment is managed via Helm chart (helm/counter-service/)
# and deployed via Argo CD GitOps.
# 
# To deploy, use: helm install counter-service ./helm/counter-service -n prod
# Or let Argo CD manage it via k8s/argocd/counter-service-application.yaml

apiVersion: apps/v1
kind: Deployment
metadata:
  name: counter-service
  namespace: prod
spec:
  replicas: 2
  revisionHistoryLimit: 3
  selector:
    matchLabels:
      app: counter-service
  template:
    metadata:
      labels:
        app: counter-service
    spec:
      restartPolicy: Always
      terminationGracePeriodSeconds: 30
      serviceAccountName: counter-service
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        fsGroup: 1000
        seccompProfile:
          type: RuntimeDefault
      topologySpreadConstraints:
        - maxSkew: 1
          topologyKey: topology.kubernetes.io/zone
          whenUnsatisfiable: DoNotSchedule
          labelSelector:
            matchLabels:
              app: counter-service
      containers:
        - name: counter-service
          image: 630943284793.dkr.ecr.eu-west-2.amazonaws.com/counter-service:latest
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 8000
          env:
            - name: REDIS_HOST
              value: counter-redis-master
            - name: REDIS_PORT
              value: "6379"
            - name: REDIS_DB
              value: "0"
          readinessProbe:
            httpGet:
              path: /health
              port: 8000
            initialDelaySeconds: 5
            periodSeconds: 10
          livenessProbe:
            httpGet:
              path: /health
              port: 8000
            initialDelaySeconds: 15
            periodSeconds: 20
          resources:
            requests:
              cpu: "100m"
              memory: "128Mi"
            limits:
              cpu: "500m"
              memory: "256Mi"
          securityContext:
            readOnlyRootFilesystem: true
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            seccompProfile:
              type: RuntimeDefault
